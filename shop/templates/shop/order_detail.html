{% extends "shop/base.html" %}
{% load static %}
{% block title %}{{ order.code }} ¬∑ Pedido{% endblock %}

{% block content %}
<style>
  .status-pill{
    border-radius: 999px;
    padding: .42rem .75rem;
    font-weight: 900;
    border: 1px solid rgba(255,255,255,.35);
    box-shadow: 0 10px 20px rgba(0,0,0,.10);
    color:#fff;
  }
  .st-NEW{ background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(139,92,246,.95)); }
  .st-CONFIRMED{ background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(99,102,241,.95)); }
  .st-PAID{ background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(22,163,74,.95)); }
  .st-DELIVERED{ background: linear-gradient(135deg, rgba(236,72,153,.95), rgba(139,92,246,.95)); }
  .st-CANCELLED{ background: rgba(107,114,128,.92); color:#fff; }

  .soft-line{ border-top: 1px solid rgba(17,24,39,.08); }

  .btn-gradient{
    border:0;
    color:#fff !important;
    border-radius: 14px;
    font-weight: 900;
    padding: .62rem 1.05rem;
    background: linear-gradient(135deg, #ec4899, #8b5cf6);
    box-shadow: 0 16px 34px rgba(236,72,153,.18);
    transition: transform .12s ease, filter .12s ease;
  }
  .btn-gradient:hover{ filter: brightness(1.03); transform: translateY(-1px); }

  .btn-ghost{
    border-radius: 14px;
    font-weight: 900;
    padding: .62rem 1.05rem;
    border: 1px solid rgba(17,24,39,.10);
    background: rgba(255,255,255,.86);
    color: #111827;
  }
  .btn-ghost:hover{ background: rgba(255,255,255,.96); }

  .thumb{
    width:100%;
    max-height: 220px;
    object-fit: cover;
    border-radius: 16px;
    border: 1px solid rgba(17,24,39,.08);
    box-shadow: 0 14px 34px rgba(17,24,39,.12);
  }

  .pay-wrap{
    border: 1px solid rgba(17,24,39,.08);
    background: rgba(255,255,255,.70);
    border-radius: 18px;
    padding: 14px;
  }

  .qr-img{
    width: 100%;
    max-width: 260px;
    border-radius: 16px;
    border: 1px solid rgba(17,24,39,.08);
    box-shadow: 0 14px 34px rgba(17,24,39,.12);
  }

  .toastx{
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9999;
    padding: 10px 14px;
    border-radius: 14px;
    background: rgba(17,24,39,.92);
    color: #fff;
    font-weight: 700;
    box-shadow: 0 18px 50px rgba(0,0,0,.22);
    display:none;
  }
</style>

<div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <div class="text-muted small">Tu pedido</div>
    <h2 class="fw-bold mb-1">Pedido {{ order.code }}</h2>

    <div class="d-flex align-items-center gap-2 flex-wrap">
      <span class="status-pill st-{{ order.status }}">{{ order.get_status_display }}</span>
      <span class="text-muted">¬∑ Total: <b>S/ {{ order.total }}</b></span>
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <a class="btn btn-ghost" href="{% url 'track_order' %}">‚Üê Mis pedidos</a>
    <a class="btn btn-gradient" href="https://wa.me/51944739301" target="_blank">üí¨ Hablar con Daniela</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-7">
    <div class="card glass-card border-0">
      <div class="card-body p-4">
        <h5 class="fw-bold mb-3">üõçÔ∏è Productos</h5>

        <div class="vstack gap-3">
          {% for it in items %}
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ it.product.name }}</div>
              <div class="text-muted small">{{ it.qty }} √ó S/ {{ it.unit_price }}</div>
            </div>
            <div class="fw-bold">S/ {{ it.subtotal }}</div>
          </div>
          {% endfor %}
        </div>

        <hr class="soft-line my-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted">Total</div>
          <div class="fs-3 fw-bold">S/ {{ order.total }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card glass-card border-0">
      <div class="card-body p-4">
        <h5 class="fw-bold mb-2">üì¶ Datos</h5>
        <div class="text-muted small">Delivery por coordinaci√≥n</div>

        <div class="mt-3">
          <div><b>Cliente:</b> {{ order.full_name }}</div>
          <div><b>WhatsApp:</b> {{ order.whatsapp }}</div>
          {% if order.address %}<div><b>Direcci√≥n:</b> {{ order.address }}</div>{% endif %}
          {% if order.reference %}<div><b>Referencia:</b> {{ order.reference }}</div>{% endif %}
          {% if order.notes %}<div><b>Notas:</b> {{ order.notes }}</div>{% endif %}
        </div>

        <hr class="soft-line my-3">

        <!-- ‚úÖ PAGO YAPE (manual pero f√°cil) -->
        <div class="pay-wrap mb-3">
          <div class="fw-bold mb-1">üíö Paga con Yape</div>
          <div class="text-muted small mb-2">
            Escanea el QR y paga exactamente <b>S/ {{ order.total }}</b>.
            Luego sube tu comprobante abajo üíñ
          </div>

          <div class="d-flex gap-3 align-items-center flex-wrap">
            <div class="text-center">
              <img class="qr-img" src="{% static 'img/yape_qr.png' %}" alt="QR Yape">
              <div class="text-muted small mt-2">QR Yape</div>
            </div>

            <div class="flex-grow-1">
              <div class="text-muted small">Monto</div>
              <div class="fw-bold fs-4 mb-2">S/ <span id="payAmount">{{ order.total }}</span></div>

              <div class="text-muted small">N√∫mero Yape</div>
              <div class="fw-bold fs-5 mb-3" id="payPhone">51944739301</div>

              <div class="d-grid gap-2">
                <button type="button" class="btn btn-ghost" id="btnCopyAmount">üìã Copiar monto</button>
                <button type="button" class="btn btn-ghost" id="btnCopyPhone">üìã Copiar n√∫mero</button>
                <button type="button" class="btn btn-gradient" id="btnWhatsApp">
                  ‚úÖ Ya pagu√© ‚Äî Enviar mensaje por WhatsApp
                </button>
              </div>

              <div class="text-muted small mt-2">
                Consejo: al pagar, en el mensaje pon <b>{{ order.code }}</b>.
              </div>
            </div>
          </div>
        </div>

        <h6 class="fw-bold mb-2">üì∏ Comprobante (opcional)</h6>

        {% if order.receipt_image %}
          <img class="thumb mb-2" src="{{ order.receipt_image.url }}" alt="Comprobante">
          <div class="d-flex gap-2">
            <a class="btn btn-ghost w-50" href="{{ order.receipt_image.url }}" target="_blank">Ver grande</a>
            <a class="btn btn-gradient w-50" href="https://wa.me/51944739301" target="_blank">Enviar por WhatsApp</a>
          </div>
          <div class="text-muted small mt-2">Si quieres, puedes subir otra foto para reemplazarla.</div>
        {% else %}
          <div class="text-muted small mb-2">
            Si ya realizaste el pago, sube una foto clara del comprobante para que Daniela lo verifique üíñ
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" action="{% url 'upload_receipt' order.code %}" class="mt-2">
          {% csrf_token %}
          {{ upload_form.receipt_image }}
          <button class="btn btn-gradient w-100 mt-2" type="submit">Subir foto</button>
        </form>

        <div class="text-muted small mt-2">
          Tip: procura que se vea el monto y la fecha.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toastx" id="toastx">Copiado ‚úÖ</div>

<script>
  const toastx = document.getElementById("toastx");
  function showToast(msg){
    toastx.textContent = msg || "Copiado ‚úÖ";
    toastx.style.display = "block";
    setTimeout(() => toastx.style.display = "none", 1400);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  const amount = document.getElementById("payAmount").innerText.trim();  // "174.54"
  const phone = document.getElementById("payPhone").innerText.trim();    // "51944739301"
  const code = "{{ order.code }}";

  document.getElementById("btnCopyAmount").addEventListener("click", async () => {
    // copiamos solo el n√∫mero, sin "S/"
    const ok = await copyText(amount);
    showToast(ok ? "Monto copiado ‚úÖ" : "No se pudo copiar");
  });

  document.getElementById("btnCopyPhone").addEventListener("click", async () => {
    const ok = await copyText(phone);
    showToast(ok ? "N√∫mero copiado ‚úÖ" : "No se pudo copiar");
  });

  document.getElementById("btnWhatsApp").addEventListener("click", () => {
    const msg =
      `Hola Daniela üíñ, ya realic√© el pago por Yape.\n` +
      `Pedido: ${code}\n` +
      `Monto: S/ ${amount}\n` +
      `Adjunto mi comprobante por la web (o por aqu√≠).`;

    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  });
</script>

{% endblock %}
